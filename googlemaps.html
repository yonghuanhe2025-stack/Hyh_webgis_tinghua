<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Cesium 影像叠加 + MQTT 日志轨迹（单面板 / 高分底图 / 边走边绘制）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/cesium@1.114.0/Build/Cesium/Widgets/widgets.css">
  <style>
    :root{ --bg:#0b1221; --panel:#121a2b; --muted:#8aa0c6; --text:#e7eefc; --border:#263247; --accent:#38bdf8; }
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; background:var(--bg); }

    .chrome{ position:fixed; inset:12px; z-index:10; pointer-events:none; }
    .card{
      pointer-events:auto;
      width:25vw;                                     /* 单面板宽 = 视口 1/4 */
      min-width:340px;
      max-height:calc((100vh - 24px) * 0.6667);       /* 高 = 视口 2/3 */
      background:rgba(18,26,43,.92); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35); color:var(--text);
      font:13px system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex; flex-direction:column;
    }
    @media (max-width:640px){ .card{ width:100%; } }  /* 小屏占满 */

    .card.minimized .panel{ display:none; }
    .card-header{ display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:rgba(18,26,43,.95); border-bottom:1px solid var(--border); border-radius:12px 12px 0 0; }
    .card-header span{ font-weight:600; font-size:14px; }
    .card-header .actions{ display:flex; gap:6px; }
    .card-header button{ background:#0f1626; border:1px solid var(--border); color:var(--muted); cursor:pointer; font-size:12px; padding:4px 8px; border-radius:8px; }
    .panel{ padding:8px 12px; overflow:auto; }

    details.section{ margin:8px 0; border:1px solid var(--border); border-radius:10px; background:#0f1626; }
    details.section > summary{ list-style:none; cursor:pointer; user-select:none; padding:10px 12px; font-weight:600; color:#cfe6ff; border-radius:10px; outline:none; }
    details.section[open] > summary{ background:rgba(56,189,248,.08); border-bottom:1px solid var(--border); border-radius:10px 10px 0 0; }
    .section-body{ padding:10px 12px; }
    .row{ display:flex; gap:8px; }
    .row > *{ flex:1; }
    label{ display:block; margin:6px 0 4px; color:var(--muted); }
    input[type="text"], select, input[type="number"]{ width:100%; background:#0f1626; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    input[type="range"], input[type="datetime-local"]{ width:100%; }
    .btn{ cursor:pointer; user-select:none; border:1px solid var(--border); background:#0f1626; color:#e7eefc; padding:8px 10px; border-radius:10px; }
    .btn:hover{ border-color:#365282; }
    .pill{ padding:4px 8px; border-radius:999px; background:rgba(56,189,248,.1); border:1px solid rgba(56,189,248,.35); color:#bfe9ff; font-size:12px; }
    .status{ font-size:12px; color:#a9b7d1; margin-top:6px; }
    .muted{ color:#8aa0c6; font-size:12px; }
    .legend{ display:flex; align-items:center; gap:8px; margin-top:6px; }
    .legend > div{ width:44px; height:10px; background:linear-gradient(to right, #00f, #0ff, #0f0, #ff0, #f60, #f00); border-radius:8px; border:1px solid #2b3a57; }

    .credits-fix .cesium-widget-credits{ background:rgba(0,0,0,.35); }
  </style>
</head>
<body class="credits-fix">
  <div class="chrome">
    <div class="card" id="cardAll">
      <div class="card-header">
        <span>控制台（影像 / 轨迹 / 视图 / 导出）</span>
        <div class="actions">
          <button id="collapseAll">折叠全部</button>
          <button id="expandAll">展开全部</button>
          <button onclick="toggleCard('cardAll')">—</button>
        </div>
      </div>

      <div class="panel">
        <!-- 1) 影像与范围 -->
        <details class="section" id="secImagery" open>
          <summary>影像与范围</summary>
          <div class="section-body">
            <label>切片 URL 模板（TMS/XYZ）</label>
            <input id="tileUrl" type="text" value="{z}/{x}/{reverseY}.png" placeholder="tiles/{z}/{x}/{reverseY}.png 或 {z}/{x}/{y}.png">
            <div class="row">
              <div>
                <label>坐标系</label>
                <select id="proj"><option value="3857" selected>WebMercator (EPSG:3857)</option></select>
              </div>
              <div>
                <label>Y 轴</label>
                <select id="yMode"><option value="tms" selected>TMS（{reverseY}）</option><option value="xyz">XYZ（{y}）</option></select>
              </div>
            </div>
            <div class="row">
              <div><label>最小级别</label><input type="number" id="minLevel" value="0" min="0" max="24"></div>
              <div><label>最大级别</label><input type="number" id="maxLevel" value="18" min="0" max="24"></div>
            </div>
            <div class="row">
              <div><label>西经</label><input type="text" id="west"  value="120.6456660990271"></div>
              <div><label>南纬</label><input type="text" id="south" value="31.461523309707065"></div>
            </div>
            <div class="row">
              <div><label>东经</label><input type="text" id="east"  value="120.65017236915412"></div>
              <div><label>北纬</label><input type="text" id="north" value="31.465391329032933"></div>
            </div>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="btnApply">应用/重载切片</button>
              <button class="btn" id="btnFly">飞到影像范围</button>
            </div>
            <div class="status" id="status">状态：就绪</div>
          </div>
        </details>

        <!-- 2) 渲染与底图（加入高分底图选项） -->
        <details class="section" id="secRender" open>
          <summary>渲染与底图</summary>
          <div class="section-body">
            <label>透明度 <span id="alphaVal" class="pill">0.75</span></label>
            <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.75">
            <div class="row">
              <div><label>亮度</label><input id="brightness" type="range" min="0" max="3" step="0.01" value="1"></div>
              <div><label>对比度</label><input id="contrast" type="range" min="0" max="3" step="0.01" value="1.2"></div>
            </div>
            <div class="row">
              <div><label>饱和度</label><input id="saturation" type="range" min="0" max="3" step="0.01" value="1.1"></div>
              <div><label>色相</label><input id="hue" type="range" min="-1" max="1" step="0.01" value="0"></div>
            </div>
            <label>底图</label>
            <select id="basemap">
              <option value="esri" selected>ESRI World Imagery（高分）</option>
              <option value="carto">Carto Light（Retina）</option>
              <option value="eox">EOX Sentinel-2 cloudless</option>
              <option value="osm">OSM 标准</option>
              <option value="none">无底图</option>
            </select>
          </div>
        </details>

        <!-- 3) GPS 轨迹（MQTT 日志） -->
        <details class="section" id="secTrack" open>
          <summary>GPS 轨迹</summary>
          <div class="section-body">
            <label>选择 MQTT 日志（.txt）</label>
            <input id="logPicker" type="file" accept=".txt" />
            <div class="row" style="margin-top:6px;">
              <div><label>开始时间（可选）</label><input id="startTime" type="datetime-local"></div>
              <div><label>结束时间（可选）</label><input id="endTime" type="datetime-local"></div>
            </div>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="btnLoadLog">载入</button>
              <button class="btn" id="btnClearGPS">清除</button>
            </div>
            <div class="legend"><div></div><span class="muted">速度着色：慢→快</span></div>
            <div class="status" id="gpsStatus">状态：未加载</div>
            <div class="muted" style="margin-top:6px;">
              解析 <code>$GPCHC</code>（纬=第13列，经=第14列，高=第15列）；兼容 <b>$GPGGA/$GNGGA、$GPRMC/$GNRMC</b>。行首方括号为时间戳。
            </div>
          </div>
        </details>

        <!-- 4) 视图 & 工具（播放 / 导出） -->
        <details class="section" id="secTools" open>
          <summary>视图 & 工具</summary>
          <div class="section-body">
            <div class="row" style="margin-bottom:8px;">
              <button class="btn" id="btn2D">2D</button>
              <button class="btn" id="btn3D">3D</button>
              <button class="btn" id="btnReset">重置相机</button>
            </div>
            <div style="margin-top:-4px; margin-bottom:12px;">
              <span class="pill">提示</span>
              <span class="status">滚轮=缩放，中键拖=倾斜，右键拖=旋转</span>
            </div>

            <div class="row" style="margin-bottom:8px;">
              <button class="btn" id="btnExportGeoJSON">导出 GeoJSON</button>
              <button class="btn" id="btnExportCSV">导出 CSV</button>
            </div>

            <label class="muted">播放速度 <span id="spdVal" class="pill">1.0x</span></label>
            <input id="speed" type="range" min="0.1" max="5" step="0.1" value="1">

            <div class="row">
              <div>
                <label class="muted">跳过 ≥（秒）的空档</label>
                <input id="skipGap" type="number" value="5" min="0" step="1">
              </div>
              <div>
                <label class="muted">最大跨段距离（m）</label>
                <input id="maxJump" type="number" value="200" min="0" step="10">
              </div>
            </div>

            <div class="row" style="align-items:center; margin-top:6px;">
              <label><input type="checkbox" id="follow" checked> 自动跟随相机</label>
              <button class="btn" id="btnPlay">开始播放（边走边画）</button>
              <button class="btn" id="btnPause">暂停</button>
            </div>
            <div class="status" id="toolStatus">状态：就绪（请先载入日志）</div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <script src="https://unpkg.com/cesium@1.114.0/Build/Cesium/Cesium.js"></script>
  <script>
    // 折叠/展开
    function toggleCard(id){ document.getElementById(id).classList.toggle('minimized'); }
    document.getElementById('collapseAll').onclick = ()=> document.querySelectorAll('details.section').forEach(d=> d.open=false);
    document.getElementById('expandAll').onclick  = ()=> document.querySelectorAll('details.section').forEach(d=> d.open=true);

    // Cesium Viewer（提升渲染分辨率到最多 2x）
    const viewer = new Cesium.Viewer('cesiumContainer', {
      animation:false, baseLayerPicker:false, geocoder:false, homeButton:false,
      infoBox:false, sceneModePicker:false, selectionIndicator:false, timeline:false,
      navigationHelpButton:false, fullscreenButton:false,
      skyBox:false, skyAtmosphere:false, terrain:undefined, imageryProvider:false,
      requestRenderMode:true, maximumRenderTimeChange: Infinity
    });
    const ssc = viewer.scene.screenSpaceCameraController;
    ssc.zoomEventTypes = [Cesium.CameraEventType.WHEEL, Cesium.CameraEventType.PINCH];
    ssc.tiltEventTypes = [Cesium.CameraEventType.MIDDLE_DRAG, Cesium.CameraEventType.PINCH, Cesium.CameraEventType.RIGHT_DRAG];
    viewer.resolutionScale = Math.min(2.0, window.devicePixelRatio || 1);  // ← 提升渲染分辨率
    viewer.shadows = false; viewer.scene.globe.enableLighting = false;

    // 视图按钮
    document.getElementById('btn2D').onclick    = ()=> viewer.scene.morphTo2D(0.8);
    document.getElementById('btn3D').onclick    = ()=> viewer.scene.morphTo3D(0.8);
    document.getElementById('btnReset').onclick = ()=> viewer.camera.setView({ destination: getRect() });

    // ======= 高分底图 =======
    let baseLayer;
    function setBasemap(kind){
      if (baseLayer) viewer.imageryLayers.remove(baseLayer, true);
      const wm = new Cesium.WebMercatorTilingScheme();

      if (kind === 'esri') {
        // ESRI World Imagery（缩放更深，清晰度高）
        baseLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
          url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          tilingScheme: wm, maximumLevel: 20,
          credit: 'Source: Esri — Esri, Maxar, Earthstar Geographics, and the GIS User Community'
        }));
      } else if (kind === 'carto') {
        // Carto Light：自动 Retina（@2x, 512px 瓦片）
        const isRetina = (window.devicePixelRatio || 1) > 1.1;
        const url = `https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}${isRetina?'@2x':''}.png`;
        baseLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
          url, tilingScheme: wm, subdomains: ['a','b','c','d'],
          tileWidth: isRetina ? 512 : 256, tileHeight: isRetina ? 512 : 256,
          maximumLevel: 20,
          credit: '© CARTO, © OpenStreetMap contributors'
        }));
      } else if (kind === 'eox') {
        baseLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
          url: 'https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless-2021_3857/default/GoogleMapsCompatible/{z}/{y}/{x}.jpg',
          tilingScheme: wm, maximumLevel: 14,
          credit: 'Sentinel-2 cloudless © EOX IT Services GmbH; © ESA'
        }));
      } else if (kind === 'osm') {
        baseLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
          url: 'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
          tilingScheme: wm, maximumLevel: 19,
          credit: '© OpenStreetMap contributors'
        }));
      } else {
        baseLayer = null;
      }
      viewer.scene.requestRender();
    }

    // ======= 影像（DOM 切片） =======
    let domLayer;
    function getRect(){
      const west  = parseFloat(document.getElementById('west').value);
      const south = parseFloat(document.getElementById('south').value);
      const east  = parseFloat(document.getElementById('east').value);
      const north = parseFloat(document.getElementById('north').value);
      return Cesium.Rectangle.fromDegrees(west, south, east, north);
    }
    function applyDomLayer(){
      const status = document.getElementById('status');
      const yMode = document.getElementById('yMode').value;
      const tplInput = document.getElementById('tileUrl').value.trim();
      const tpl = yMode === 'tms' ? tplInput.replace('{y}','{reverseY}') : tplInput.replace('{reverseY}','{y}');
      const minLevel = parseInt(document.getElementById('minLevel').value,10);
      const maxLevel = parseInt(document.getElementById('maxLevel').value,10);
      if (domLayer) { viewer.imageryLayers.remove(domLayer, true); domLayer = null; }
      const provider = new Cesium.UrlTemplateImageryProvider({
        url: tpl, tilingScheme: new Cesium.WebMercatorTilingScheme(), rectangle: getRect(),
        minimumLevel: Math.max(0, Math.min(minLevel, maxLevel)),
        maximumLevel: Math.max(0, Math.max(minLevel, maxLevel)),
        tileWidth:256, tileHeight:256, credit:'Tiles © GDAL2Tiles / Data: DOM'
      });
      provider.errorEvent.addEventListener((err)=>{ status.textContent = '状态：切片请求异常 - '+ err.message; });
      domLayer = viewer.imageryLayers.addImageryProvider(provider);
      domLayer.alpha = parseFloat(document.getElementById('alpha').value);
      bindToneMapping(domLayer); viewer.imageryLayers.raiseToTop(domLayer);
      status.textContent = '状态：切片已加载'; viewer.scene.requestRender();
    }
    function flyToRect(){ viewer.camera.flyTo({ destination: getRect(), duration: 1.2 }); }

    function bindToneMapping(layer){
      const ids = ['brightness','contrast','saturation','hue'];
      function update(){
        layer.brightness = parseFloat(document.getElementById('brightness').value);
        layer.contrast   = parseFloat(document.getElementById('contrast').value);
        layer.saturation = parseFloat(document.getElementById('saturation').value);
        layer.hue        = parseFloat(document.getElementById('hue').value);
        viewer.scene.requestRender();
      }
      ids.forEach(id=> document.getElementById(id).oninput = update); update();
    }

    document.getElementById('alpha').addEventListener('input', (e)=>{ const v = parseFloat(e.target.value); document.getElementById('alphaVal').textContent = v.toFixed(2); if (domLayer) domLayer.alpha = v; viewer.scene.requestRender(); });
    document.getElementById('btnApply').onclick = applyDomLayer;
    document.getElementById('btnFly').onclick   = flyToRect;
    document.getElementById('basemap').onchange = (e)=> setBasemap(e.target.value);

    // 初始：默认高分 ESRI
    setBasemap('esri'); 
    applyDomLayer(); 
    flyToRect();

    const h = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    ['MOUSE_MOVE','WHEEL'].forEach(t=>{ h.setInputAction(()=> viewer.scene.requestRender(), Cesium.ScreenSpaceEventType[t]); });

    // =========================== 轨迹解析 / 播放 ===========================
    let allPoints = []; let gpsSegments = [];
    let playIdx = 0; let playEntity = null; let playTimerId = null; let isPlaying = false;
    let liveSegments = [];

    function parseBracketTimestamp(line){
      const m = line.match(/\[(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})\]/);
      if(!m) return null;
      return new Date(m[1].replaceAll('-','/')+' '+m[2]); // 本地时区
    }
    function nmeaLatLonToDeg(val,hemi){
      if(!val) return null; const f = parseFloat(val); if(isNaN(f)) return null;
      const deg = Math.floor(f/100); const min = f - deg*100; let out = deg + (min/60);
      if(hemi==='S'||hemi==='W') out = -out; return out;
    }
    function tryParseRMC(line){
      if(!/\$(GPRMC|GNRMC)/.test(line)) return null;
      const p = line.split(','); if(p.length<12) return null; if(p[2]!=='A') return null;
      const lat = nmeaLatLonToDeg(p[3],p[4]); const lon = nmeaLatLonToDeg(p[5],p[6]); if(lat==null||lon==null) return null;
      return {lat,lon,alt:0};
    }
    function tryParseGGA(line){
      if(!/\$(GPGGA|GNGGA)/.test(line)) return null;
      const p = line.split(','); if(p.length<10) return null; if(p[6]==='0'||p[6]==='') return null;
      const lat = nmeaLatLonToDeg(p[2],p[3]); const lon = nmeaLatLonToDeg(p[4],p[5]); const alt = parseFloat(p[9])||0;
      if(lat==null||lon==null) return null; return {lat,lon,alt};
    }
    function tryParseGPCHC(line){
      if(!/\$GPCHC/.test(line)) return null;
      const p = line.split(','); if(p.length < 15) return null;
      const lat = parseFloat(p[12]); const lon = parseFloat(p[13]); const alt = parseFloat(p[14])||0;
      if(isNaN(lat)||isNaN(lon)) return null;
      return {lat,lon,alt};
    }
    function haversine(lon1,lat1,lon2,lat2){
      const R=6371000; const toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function speedColor(v){
      const kmh = v*3.6; const stops=[0,5,15,30,60,90];
      const colors=[[0,0,255],[0,255,255],[0,255,0],[255,255,0],[255,102,0],[255,0,0]];
      if(kmh<=stops[0]) return Cesium.Color.fromBytes(...colors[0]);
      if(kmh>=stops.at(-1)) return Cesium.Color.fromBytes(...colors.at(-1));
      let i=0; while(kmh>stops[i+1]) i++;
      const t=(kmh-stops[i])/(stops[i+1]-stops[i]);
      const c=colors[i].map((v,j)=>Math.round(v*(1-t)+colors[i+1][j]*t));
      return Cesium.Color.fromBytes(...c);
    }

    function exportGeoJSON(){
      const fc = { type:'FeatureCollection', features: [] };
      for(const seg of gpsSegments){
        const coords = seg.points.map(p=>[p.lon, p.lat, p.alt||0]);
        const times  = seg.points.map(p=> new Date(p.time).toISOString());
        fc.features.push({ type:'Feature', properties:{ times }, geometry:{ type:'LineString', coordinates: coords } });
      }
      const blob = new Blob([JSON.stringify(fc,null,2)], {type:'application/geo+json'});
      const url = URL.createObjectURL(blob); download(url, 'track.geojson');
    }
    function exportCSV(){
      let rows = ['time,lon,lat,alt,speed_m_s'];
      for(const seg of gpsSegments){
        for(const p of seg.points){
          rows.push(`${new Date(p.time).toISOString()},${p.lon},${p.lat},${p.alt||0},${p.speed??''}`);
        }
      }
      const blob = new Blob([rows.join('\n')], {type:'text/csv'}); const url = URL.createObjectURL(blob); download(url, 'track.csv');
    }
    function download(url, name){ const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    async function parseLogFile(file){
      const status = document.getElementById('gpsStatus'); status.textContent = '状态：读取中...';
      const st = document.getElementById('startTime').value; const et = document.getElementById('endTime').value;
      const tMin = st? new Date(st):null; const tMax = et? new Date(et):null;

      const text = await file.text();
      const lines = text.split(/\r?\n/);
      const points=[];
      for(const line of lines){
        if(!line) continue;
        const tt = parseBracketTimestamp(line); if(!tt) continue;
        if(tMin&&tt<tMin) continue; if(tMax&&tt>tMax) continue;

        let pos = tryParseGPCHC(line) || tryParseGGA(line) || tryParseRMC(line);
        if(!pos) continue;
        points.push({time:tt, lon:pos.lon, lat:pos.lat, alt:pos.alt||0});
      }
      if(points.length===0){ status.textContent='状态：未解析到坐标（检查日志格式/时间筛选）'; return []; }
      points.sort((a,b)=> a.time - b.time);

      for(let i=1;i<points.length;i++){
        const a=points[i-1], b=points[i]; const dt=(b.time-a.time)/1000;
        const dist=haversine(a.lon,a.lat,b.lon,b.lat);
        points[i].speed = dt>0? (dist/dt) : 0;
      }
      status.textContent = `状态：解析到 ${points.length} 个点`;
      return points;
    }

    document.getElementById('btnLoadLog').onclick = async ()=>{
      const input = document.getElementById('logPicker');
      if(!input.files || input.files.length===0){
        document.getElementById('gpsStatus').textContent='状态：请选择 MQTT 日志（.txt）';
        return;
      }
      resetAll();
      allPoints = await parseLogFile(input.files[0]);
      if(allPoints.length===0) return;

      gpsSegments = [{points: allPoints}];
      playIdx = 0;

      const positions = allPoints.map(p=> Cesium.Cartesian3.fromDegrees(p.lon,p.lat,p.alt||0));
      const bs = Cesium.BoundingSphere.fromPoints(positions);
      if (positions.length>0) viewer.camera.flyToBoundingSphere(bs, {duration:1.2});

      document.getElementById('toolStatus').textContent = '状态：已载入，可开始播放（边走边画）';
      viewer.scene.requestRender();
    };

    function resetAll(){
      for (const e of liveSegments){ viewer.entities.remove(e); }
      liveSegments = [];
      if (playEntity){ viewer.entities.remove(playEntity); playEntity=null; }
      isPlaying=false;
      if (playTimerId){ clearTimeout(playTimerId); playTimerId=null; }
      allPoints=[]; gpsSegments=[]; playIdx=0;
      document.getElementById('gpsStatus').textContent='状态：未加载';
      document.getElementById('toolStatus').textContent='状态：就绪（请先载入日志）';
      viewer.scene.requestRender();
    }
    document.getElementById('btnClearGPS').onclick = ()=>{
      resetAll();
      applyDomLayer(); setBasemap(document.getElementById('basemap').value||'esri');
    };

    function ensurePlayEntity(){
      if(playEntity) return playEntity;
      playEntity = viewer.entities.add({
        point:{ pixelSize:10, color: Cesium.Color.ORANGE, outlineColor: Cesium.Color.BLACK, outlineWidth:2 },
        label:{ text:'播放', font:'13px sans-serif', pixelOffset:new Cesium.Cartesian2(0,-18),
                fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth:2 }
      });
      return playEntity;
    }

    function tickPlayback(){
      if(!isPlaying || allPoints.length === 0) return;

      const p = allPoints[playIdx];
      const ent = ensurePlayEntity();
      ent.position = Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.alt || 0);

      if (document.getElementById('follow').checked){
        const h = viewer.camera.positionCartographic.height || 200;
        viewer.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, h) });
      }

      if (playIdx > 0){
        const prev = allPoints[playIdx-1];
        const dtSec = (p.time - prev.time)/1000;
        const distM = haversine(prev.lon,prev.lat,p.lon,p.lat);
        const skipGapSec = Math.max(0, parseFloat(document.getElementById('skipGap').value || '0'));
        const maxJumpM   = Math.max(0, parseFloat(document.getElementById('maxJump').value || '0'));
        const tooLong = (skipGapSec>0 && dtSec >= skipGapSec);
        const tooFar  = (maxJumpM>0 && distM > maxJumpM);

        if (!tooLong && !tooFar){
          const speed = (dtSec>0)? (distM/dtSec) : 0;
          const color = speedColor(speed);
          const seg = viewer.entities.add({
            polyline:{
              positions:[
                Cesium.Cartesian3.fromDegrees(prev.lon,prev.lat,prev.alt||0),
                Cesium.Cartesian3.fromDegrees(p.lon,p.lat,p.alt||0)
              ],
              width:3, arcType: Cesium.ArcType.GEODESIC, material: color
            }
          });
          liveSegments.push(seg);
        }
      }

      viewer.scene.requestRender();

      const speedMul = Math.max(0.1, parseFloat(document.getElementById('speed').value || '1'));
      document.getElementById('spdVal').textContent = `${speedMul.toFixed(1)}x`;
      let delayMs = 800;
      if (playIdx < allPoints.length - 1){
        const t0 = allPoints[playIdx].time, t1 = allPoints[playIdx+1].time;
        const dtSec = (t1 - t0)/1000;
        const skipGapSec = Math.max(0, parseFloat(document.getElementById('skipGap').value || '0'));
        if (skipGapSec>0 && dtSec >= skipGapSec){
          delayMs = 120;
        } else {
          delayMs = Math.max(50, Math.min(3000, (dtSec*1000)/speedMul));
        }
      }

      playIdx = (playIdx + 1) % allPoints.length;   // 循环
      playTimerId = setTimeout(tickPlayback, delayMs);
    }

    function startPlay(){
      if(allPoints.length === 0){
        document.getElementById('toolStatus').textContent = '状态：无可播放轨迹，请先载入日志';
        return;
      }
      if(isPlaying) return;

      for (const e of liveSegments){ viewer.entities.remove(e); }
      liveSegments = [];

      const ent = ensurePlayEntity();
      const p0 = allPoints[0];
      ent.position = Cesium.Cartesian3.fromDegrees(p0.lon, p0.lat, p0.alt || 0);

      isPlaying = true;
      document.getElementById('toolStatus').textContent = '状态：按真实间隔播放中（边走边绘制）…';
      tickPlayback();
    }
    function pausePlay(){
      isPlaying = false;
      if (playTimerId){ clearTimeout(playTimerId); playTimerId = null; }
      document.getElementById('toolStatus').textContent = '状态：已暂停';
    }
    document.getElementById('btnPlay').onclick = startPlay;
    document.getElementById('btnPause').onclick = pausePlay;

    document.getElementById('btnExportGeoJSON').onclick = exportGeoJSON;
    document.getElementById('btnExportCSV').onclick    = exportCSV;
  </script>
</body>
</html>
